{% extends "base.html" %}

{% block title %}Публичные статьи - База знаний{% endblock %}

{% block page_title %}Публичные статьи{% endblock %}

{% block main %}
<div>
    <div style="background: #e8f4fc; padding: 1.5rem; border-radius: 4px; margin-bottom: 2rem;">
        <h3 style="margin-bottom: 0.5rem;">Все публичные статьи</h3>
        <p style="color: #666; margin: 0;">Всего публичных статей: <strong>{{ total_public }}</strong></p>
    </div>
    
    <!-- Поиск -->
    <div style="background: white; padding: 1.5rem; border-radius: 4px; margin-bottom: 2rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <form action="{{ url_for('lab8.search_articles') }}" method="get" style="display: flex; gap: 1rem;">
            <input type="search" 
                   name="q" 
                   placeholder="Поиск по публичным статьям..." 
                   style="flex: 1; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;"
                   value="{{ request.args.get('q', '') }}">
            <input type="hidden" name="type" value="public">
            <button type="submit" class="btn btn-primary">Найти</button>
        </form>
    </div>
    
    {% if public_articles %}
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1.5rem;">
            {% for article in public_articles %}
            <div style="background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 1.5rem; transition: transform 0.3s, box-shadow 0.3s;">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                    <h4 style="margin: 0; flex: 1;">
                        <a href="{{ url_for('lab8.article_detail', article_id=article.id) }}" 
                           style="color: #333; text-decoration: none;">
                            {{ article.title }}
                        </a>
                    </h4>
                    <span style="background: #4CAF50; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem; white-space: nowrap;">
                        Публичная
                    </span>
                </div>
                
                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
                    <div style="width: 32px; height: 32px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                        {{ article.author.login|first|upper }}
                    </div>
                    <div>
                        <div style="font-weight: 500;">{{ article.author.login }}</div>
                        <div style="font-size: 0.875rem; color: #666;">
                            {{ article.created_at.strftime('%d.%m.%Y') if article.created_at else 'Без даты' }}
                        </div>
                    </div>
                </div>
                
                <p style="color: #555; line-height: 1.6; margin-bottom: 1rem;">
                    {{ article.article_text[:150] }}
                    {% if article.article_text|length > 150 %}...{% endif %}
                </p>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #f0f0f0;">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <span style="display: flex; align-items: center; gap: 0.25rem; color: #666;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                            </svg>
                            {{ article.likes or 0 }}
                        </span>
                    </div>
                    <a href="{{ url_for('lab8.article_detail', article_id=article.id) }}" 
                       class="btn" style="padding: 0.5rem 1rem; background: #f0f0f0; color: #333;">
                        Читать →
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- Пагинация -->
        {% if pagination.pages > 1 %}
        <div style="display: flex; justify-content: center; margin-top: 3rem; gap: 0.5rem;">
            {% if pagination.has_prev %}
                <a href="{{ url_for('lab8.public_articles', page=pagination.prev_num) }}" class="btn">
                    ← Назад
                </a>
            {% endif %}
            
            {% for page_num in pagination.iter_pages(left_edge=2, right_edge=2, left_current=2, right_current=2) %}
                {% if page_num %}
                    {% if page_num == pagination.page %}
                        <span class="btn btn-primary" style="padding: 0.5rem 1rem;">{{ page_num }}</span>
                    {% else %}
                        <a href="{{ url_for('lab8.public_articles', page=page_num) }}" class="btn">
                            {{ page_num }}
                        </a>
                    {% endif %}
                {% else %}
                    <span class="btn" style="background: transparent;">...</span>
                {% endif %}
            {% endfor %}
            
            {% if pagination.has_next %}
                <a href="{{ url_for('lab8.public_articles', page=pagination.next_num) }}" class="btn">
                    Вперед →
                </a>
            {% endif %}
        </div>
        {% endif %}
    {% else %}
        <div style="text-align: center; padding: 3rem; background: #f9f9f9; border-radius: 8px;">
            <h4 style="margin-bottom: 1rem; color: #666;">Публичных статей пока нет</h4>
            <p style="color: #888; margin-bottom: 2rem;">Будьте первым, кто поделится знаниями!</p>
            {% if current_user.is_authenticated %}
                <a href="{{ url_for('lab8.create_article') }}" class="btn btn-primary">
                    Создать публичную статью
                </a>
            {% else %}
                <a href="{{ url_for('lab8.register') }}" class="btn btn-primary">
                    Зарегистрироваться и создать статью
                </a>
            {% endif %}
        </div>
    {% endif %}
    
    <!-- Ссылки на авторов -->
    <div style="margin-top: 3rem; padding: 1.5rem; background: #f8f9fa; border-radius: 8px;">
        <h4 style="margin-bottom: 1rem;">Авторы публичных статей</h4>
        <a href="{{ url_for('lab8.article_authors') }}" class="btn" style="background: white;">
            Посмотреть всех авторов →
        </a>
    </div>
</div>

<script>
    // AJAX лайки для публичных статей
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.like-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
                const articleId = this.dataset.articleId;
                
                try {
                    const response = await fetch(`/lab8/articles/${articleId}/like`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        // Обновляем счетчик лайков
                        const likeCount = this.querySelector('.like-count');
                        if (likeCount) {
                            likeCount.textContent = data.likes;
                        }
                        
                        // Показываем сообщение
                        showFlash(data.message, 'success');
                        
                        // Делаем кнопку неактивной
                        this.disabled = true;
                        this.style.opacity = '0.6';
                    } else {
                        showFlash('Ошибка: ' + data.error, 'danger');
                    }
                } catch (error) {
                    showFlash('Ошибка сети', 'danger');
                }
            });
        });
    });
    
    function showFlash(message, type) {
        const alert = document.createElement('div');
        alert.className = `alert alert-${type}`;
        alert.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 1000; animation: slideIn 0.3s;';
        alert.innerHTML = `
            ${message}
            <button type="button" class="alert-close" style="margin-left: 1rem;">&times;</button>
        `;
        
        document.body.appendChild(alert);
        
        // Автоматическое скрытие
        setTimeout(() => {
            alert.style.opacity = '0';
            alert.style.transition = 'opacity 0.5s';
            setTimeout(() => alert.remove(), 500);
        }, 3000);
        
        // Закрытие по клику
        alert.querySelector('.alert-close').addEventListener('click', () => {
            alert.remove();
        });
    }
    
    // Анимация появления
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    `;
    document.head.appendChild(style);
</script>
{% endblock %}